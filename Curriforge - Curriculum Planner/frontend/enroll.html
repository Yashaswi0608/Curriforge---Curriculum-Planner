<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enroll a Course - CurriForge</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <button class="mobile-menu-btn" onclick="document.querySelector('.sidebar').classList.toggle('open')">‚ò∞</button>

    <div class="page-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon">üéì</div>
                <h2>CurriForge</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="/dashboard" class="nav-item" data-page="dashboard">
                    <span class="nav-icon">üìä</span> Dashboard
                </a>
                <a href="/enroll" class="nav-item" data-page="enroll">
                    <span class="nav-icon">‚ûï</span> Enroll Course
                </a>
                <a href="/courses" class="nav-item" data-page="courses">
                    <span class="nav-icon">üìö</span> My Courses
                </a>
                <a href="/practice" class="nav-item" data-page="practice">
                    <span class="nav-icon">üß†</span> Practice Hub
                </a>
                <a href="/profile" class="nav-item" data-page="profile">
                    <span class="nav-icon">üë§</span> Profile
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info" onclick="window.location.href='/profile'">
                    <div class="user-avatar">U</div>
                    <div class="user-details">
                        <div class="name">User</div>
                        <div class="email">user@email.com</div>
                    </div>
                </div>
                <a href="#" class="nav-item" onclick="logout()" style="margin-top:8px;color:var(--danger);">
                    <span class="nav-icon">üö™</span> Logout
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>Enroll a New Course with AI ‚ú®</h1>
                <p>Tell us what you want to learn, and our AI will create a personalized curriculum just for you</p>
            </div>

            <!-- Enrollment Form -->
            <div class="enroll-form-container" id="enrollForm">
                <div class="card">
                    <form onsubmit="handleEnroll(event)">
                        <div class="form-group">
                            <label class="form-label">What do you want to learn? *</label>
                            <input type="text" class="form-input" id="courseSubject" placeholder="e.g., Machine Learning, Web Development, Python, Digital Marketing" required>
                        </div>

                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Your Level *</label>
                                <select class="form-select" id="courseLevel" required>
                                    <option value="beginner">üå± Beginner</option>
                                    <option value="intermediate">üìà Intermediate</option>
                                    <option value="advanced">üöÄ Advanced</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Duration (weeks) *</label>
                                <select class="form-select" id="courseDuration">
                                    <option value="2">2 Weeks (Crash Course)</option>
                                    <option value="4" selected>4 Weeks</option>
                                    <option value="6">6 Weeks</option>
                                    <option value="8">8 Weeks</option>
                                    <option value="12">12 Weeks (Comprehensive)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Daily Study Hours</label>
                            <select class="form-select" id="courseDailyHours">
                                <option value="0.5">30 minutes</option>
                                <option value="1" selected>1 hour</option>
                                <option value="1.5">1.5 hours</option>
                                <option value="2">2 hours</option>
                                <option value="3">3 hours</option>
                                <option value="4">4+ hours</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Why do you want to learn this?</label>
                            <textarea class="form-textarea" id="courseReason" placeholder="e.g., For my career, personal project, college exam, competitive programming..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg btn-full" id="enrollBtn">
                            ü§ñ Generate Personalized Curriculum with AI
                        </button>
                    </form>
                </div>
            </div>

            <!-- AI Generated Curriculum Preview -->
            <div class="hidden" id="curriculumPreview">
                <div class="ai-response-container fade-in">
                    <div class="flex justify-between items-center mb-24">
                        <h2 id="curriculumTitle">Course Title</h2>
                        <div class="flex gap-8">
                            <button class="btn btn-secondary" onclick="resetForm()">‚Üê New Course</button>
                            <button class="btn btn-primary btn-lg" id="confirmEnrollBtn" onclick="confirmEnroll()">
                                ‚úÖ Enroll in this Course
                            </button>
                        </div>
                    </div>

                    <p id="curriculumDesc" class="text-muted mb-24" style="font-size:1.05rem"></p>

                    <!-- Tabs -->
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('overview')">Overview</button>
                        <button class="tab" onclick="switchTab('roadmap')">Roadmap</button>
                        <button class="tab" onclick="switchTab('topics')">Topics</button>
                        <button class="tab" onclick="switchTab('resources')">Resources</button>
                        <button class="tab" onclick="switchTab('schedule')">Schedule</button>
                    </div>

                    <!-- Overview Tab -->
                    <div class="tab-content active" id="tab-overview">
                        <div class="curriculum-section">
                            <h3>üìã Learning Outcomes</h3>
                            <ul id="learningOutcomes" style="list-style:none;padding:0"></ul>
                        </div>
                        <div class="curriculum-section">
                            <h3>üìå Prerequisites</h3>
                            <ul id="prerequisites" style="list-style:none;padding:0"></ul>
                        </div>
                    </div>

                    <!-- Roadmap Tab -->
                    <div class="tab-content" id="tab-roadmap">
                        <div class="roadmap-timeline" id="roadmapTimeline"></div>
                    </div>

                    <!-- Topics Tab -->
                    <div class="tab-content" id="tab-topics">
                        <div id="topicsList"></div>
                    </div>

                    <!-- Resources Tab -->
                    <div class="tab-content" id="tab-resources">
                        <div class="grid-2">
                            <div>
                                <h3 class="mb-16" style="color:var(--success)">üÜì Free Resources</h3>
                                <div id="freeResources"></div>
                            </div>
                            <div>
                                <h3 class="mb-16" style="color:var(--warning)">üí∞ Paid Resources</h3>
                                <div id="paidResources"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Tab -->
                    <div class="tab-content" id="tab-schedule">
                        <div id="scheduleContent" class="card"></div>
                    </div>
                </div>
            </div>

            <!-- Ask AI Chat -->
            <div class="card mt-24">
                <div class="card-header">
                    <h3 class="card-title">üí¨ Ask AI about this course</h3>
                </div>
                <div class="chat-input-area" style="border-top:none;padding:0;padding-top:12px">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask anything about the course, study tips, or learning advice..." onkeypress="if(event.key==='Enter') askAI()">
                    <button class="btn btn-primary" onclick="askAI()">Send</button>
                </div>
                <div id="chatResponse" class="mt-16 hidden" style="padding:16px;background:var(--bg-input);border-radius:8px;line-height:1.7"></div>
            </div>
        </main>
    </div>

    <script src="/static/js/api.js"></script>
    <script>
        if (!requireAuth()) throw new Error('Not authenticated');
        setupSidebar('enroll');

        let currentCurriculum = null;
        let enrolledCourseId = null;

        async function handleEnroll(e) {
            e.preventDefault();
            const btn = document.getElementById('enrollBtn');
            btn.disabled = true;
            btn.textContent = 'ü§ñ AI is generating your curriculum... (this may take 30-60s)';

            showLoading('ü§ñ Our AI is crafting your personalized curriculum...');

            try {
                const data = await apiFetch('/courses/enroll', {
                    method: 'POST',
                    body: JSON.stringify({
                        subject: document.getElementById('courseSubject').value,
                        level: document.getElementById('courseLevel').value,
                        reason: document.getElementById('courseReason').value || null,
                        preferred_duration_weeks: parseInt(document.getElementById('courseDuration').value),
                        daily_hours: parseFloat(document.getElementById('courseDailyHours').value),
                    }),
                });

                hideLoading();

                if (data) {
                    currentCurriculum = data.curriculum;
                    enrolledCourseId = data.course_id;
                    showToast('Curriculum generated successfully!', 'success');
                    displayCurriculum(data.curriculum);

                    // Hide form, show preview
                    document.getElementById('enrollForm').classList.add('hidden');
                    document.getElementById('curriculumPreview').classList.remove('hidden');

                    // Change enroll button to "View Planner"
                    const confirmBtn = document.getElementById('confirmEnrollBtn');
                    confirmBtn.textContent = 'üìã View Course Planner';
                    confirmBtn.onclick = () => window.location.href = `/planner/${enrolledCourseId}`;
                }
            } catch (err) {
                hideLoading();
                showToast(err.message || 'Failed to generate curriculum', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ü§ñ Generate Personalized Curriculum with AI';
            }
        }

        function displayCurriculum(data) {
            document.getElementById('curriculumTitle').textContent = data.title || 'Course';
            document.getElementById('curriculumDesc').textContent = data.description || '';

            // Overview
            const outcomes = data.curriculum?.learning_outcomes || [];
            document.getElementById('learningOutcomes').innerHTML = outcomes.map(o =>
                `<li style="padding:8px 0;border-bottom:1px solid var(--border)">‚úÖ ${escapeHtml(o)}</li>`
            ).join('');

            const prereqs = data.curriculum?.prerequisites || [];
            document.getElementById('prerequisites').innerHTML = prereqs.map(p =>
                `<li style="padding:8px 0;border-bottom:1px solid var(--border)">üìå ${escapeHtml(p)}</li>`
            ).join('') || '<li class="text-muted">No prerequisites</li>';

            // Roadmap
            const phases = data.roadmap?.phases || [];
            document.getElementById('roadmapTimeline').innerHTML = phases.map(p => `
                <div class="roadmap-phase">
                    <h4>${escapeHtml(p.name)}</h4>
                    <div class="phase-weeks">üìÖ Weeks ${p.weeks}</div>
                    <p>${escapeHtml(p.focus)}</p>
                    ${p.milestones ? `
                        <div class="mt-8">
                            ${p.milestones.map(m => `<span class="badge badge-primary" style="margin:2px">${escapeHtml(m)}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            // Topics
            const topics = data.topics || [];
            let currentWeek = 0;
            let topicsHTML = '';
            topics.forEach(t => {
                if (t.week !== currentWeek) {
                    currentWeek = t.week;
                    topicsHTML += `<div class="week-header">üìÖ Week ${currentWeek}</div>`;
                }
                const resources = t.resources || [];
                topicsHTML += `
                    <div class="topic-item">
                        <div class="topic-content">
                            <div class="topic-title">Day ${t.day}: ${escapeHtml(t.title)}</div>
                            <div class="topic-desc">${escapeHtml(t.description || '')}</div>
                            <div class="topic-meta">
                                <span>‚è±Ô∏è ${t.duration_minutes || 60} min</span>
                                ${resources.length > 0 ? `<span>üìé ${resources.length} resources</span>` : ''}
                            </div>
                            ${resources.length > 0 ? `
                                <div class="mt-8">
                                    ${resources.map(r => `
                                        <a href="${r.url || '#'}" target="_blank" class="resource-item" style="display:inline-flex;padding:4px 10px;font-size:0.8rem;margin:2px;text-decoration:none">
                                            <span class="resource-type ${r.type === 'free' ? 'free' : 'paid'}">${r.type || 'free'}</span>
                                            <span style="margin-left:6px">${escapeHtml(r.name || r.platform || 'Link')}</span>
                                        </a>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            document.getElementById('topicsList').innerHTML = topicsHTML;

            // Resources
            const freeRes = data.resources?.free || [];
            document.getElementById('freeResources').innerHTML = freeRes.map(r => `
                <a href="${r.url || '#'}" target="_blank" class="resource-item" style="text-decoration:none">
                    <span class="resource-type free">FREE</span>
                    <div style="flex:1">
                        <div style="font-weight:600">${escapeHtml(r.name || '')}</div>
                        <div class="text-muted" style="font-size:0.8rem">${escapeHtml(r.platform || '')} ‚Äî ${escapeHtml(r.description || '')}</div>
                    </div>
                </a>
            `).join('') || '<p class="text-muted">No free resources available</p>';

            const paidRes = data.resources?.paid || [];
            document.getElementById('paidResources').innerHTML = paidRes.map(r => `
                <a href="${r.url || '#'}" target="_blank" class="resource-item" style="text-decoration:none">
                    <span class="resource-type paid">${r.price || 'PAID'}</span>
                    <div style="flex:1">
                        <div style="font-weight:600">${escapeHtml(r.name || '')}</div>
                        <div class="text-muted" style="font-size:0.8rem">${escapeHtml(r.platform || '')} ‚Äî ${escapeHtml(r.description || '')}</div>
                    </div>
                </a>
            `).join('') || '<p class="text-muted">No paid resources available</p>';

            // Schedule
            const schedule = data.schedule || {};
            document.getElementById('scheduleContent').innerHTML = `
                <h4 class="mb-16" style="color:var(--primary-light)">üìÖ Your Personalized Study Schedule</h4>
                ${schedule.daily_plan ? `<div class="mb-16"><strong>Daily Plan:</strong><p class="text-muted mt-8">${escapeHtml(schedule.daily_plan)}</p></div>` : ''}
                ${schedule.weekly_structure ? `<div class="mb-16"><strong>Weekly Structure:</strong><p class="text-muted mt-8">${escapeHtml(schedule.weekly_structure)}</p></div>` : ''}
                ${schedule.tips ? `
                    <div>
                        <strong>üí° Study Tips:</strong>
                        <ul style="margin-top:8px;padding-left:20px">
                            ${schedule.tips.map(t => `<li style="padding:4px 0;color:var(--text-secondary)">${escapeHtml(t)}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function resetForm() {
            document.getElementById('enrollForm').classList.remove('hidden');
            document.getElementById('curriculumPreview').classList.add('hidden');
            currentCurriculum = null;
            enrolledCourseId = null;
        }

        function confirmEnroll() {
            if (enrolledCourseId) {
                window.location.href = `/planner/${enrolledCourseId}`;
            }
        }

        async function askAI() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            const responseDiv = document.getElementById('chatResponse');
            responseDiv.classList.remove('hidden');
            responseDiv.innerHTML = '<div class="loading-spinner"></div> Thinking...';
            input.value = '';

            try {
                const data = await apiFetch('/chat/ask', {
                    method: 'POST',
                    body: JSON.stringify({
                        message: msg,
                        course_id: enrolledCourseId || null,
                    }),
                });

                if (data) {
                    responseDiv.innerHTML = markdownToHtml(data.response);
                }
            } catch (err) {
                responseDiv.innerHTML = `<span style="color:var(--danger)">Error: ${err.message}</span>`;
            }
        }
    </script>
</body>
</html>
